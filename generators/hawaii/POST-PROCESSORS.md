# Hawaii Post-Processors

Post-processing scripts that bridge gaps in Hawaii's code generation until native support is added upstream.

## Overview

Hawaii v0.66.0 doesn't support:
1. **Discriminated unions from OpenAPI discriminators** - Schemas with `discriminator` + `oneOf` should generate F# discriminated unions
2. **JObject in multipart form data** - No overload for `Newtonsoft.Json.Linq.JObject` in RequestPart.multipartFormData

These post-processors automatically fix these issues after Hawaii generation.

## Scripts

### `post-process-discriminators.fsx`

Detects OpenAPI discriminator schemas and generates F# discriminated unions.

**Example**:
```fsharp
// Before (generated by Hawaii):
type workersbindings = list<workersbindingitem>  // workersbindingitem doesn't exist!

// After (post-processor adds):
type workersbindingitem =
    | Assets of workersbindingkindassets
    | Browser of workersbindingkindbrowser
    // ... all binding types as union cases

type workersbindings = list<workersbindingitem>
```

**Usage**:
```bash
dotnet fsi post-process-discriminators.fsx Generated-Workers/Types.fs
```

### `post-process-jobject.fsx`

Converts JObject parameters to string for multipart form data.

**Example**:
```fsharp
// Before:
RequestPart.multipartFormData ("metadata", metadata)  // metadata is JObject - no overload!

// After:
RequestPart.multipartFormData ("metadata", metadata.ToString(Newtonsoft.Json.Formatting.None))
```

**Usage**:
```bash
dotnet fsi post-process-jobject.fsx Generated-Workers/Client.fs
```

### `generate-workers.ps1`

Master generation script that runs Hawaii + both post-processors.

**Usage**:
```powershell
cd generators/hawaii
.\generate-workers.ps1
```

**Output**:
```
[1/3] Running Hawaii code generation...
[2/3] Post-processing: Adding discriminated unions...
[3/3] Post-processing: Fixing JObject multipart...
✓ Generation complete!
```

## Upstream Issue

These post-processors should be temporary. The proper fix is to add discriminator support to Hawaii itself.

**TODO**: Create GitHub issue in Hawaii repo with:
- Link to our post-processor implementations as working examples
- OpenAPI discriminator spec reference
- Test case from Cloudflare Workers API

## Implementation Notes

### Discriminator Detection

The post-processor looks for patterns like:
```fsharp
type workersbindings = list<workersbindingitem>
```

Where `workersbindingitem` is referenced but not defined. It then scans for all `workersbindingkind*` types and generates the union.

### Type Name Mapping

Converts schema names to case names:
- `workersbindingkindassets` → `Assets`
- `workersbindingkindd1` → `D1`
- `workersbindingkindkvnamespace` → `Kvnamespace`

### Idempotent Processing

Both scripts detect if already processed and skip re-processing:
```fsharp
if content.Contains("// Discriminated union (auto-generated by post-processor") then
    printfn "Already processed"
    exit 0
```

## Testing

Verify post-processors work:
```bash
# Generate fresh code
dotnet run --project D:\repos\Hawaii\src\Hawaii.fsproj -- --config workers-hawaii.json

# Run post-processors
dotnet fsi post-process-discriminators.fsx Generated-Workers/Types.fs
dotnet fsi post-process-jobject.fsx Generated-Workers/Client.fs

# Copy and build
cp Generated-Workers/*.fs ../../src/Management/CloudFlare.Management.Workers/
cd ../../
dotnet build src/Management/CloudFlare.Management.Workers/
```

Should compile with zero errors.
